<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vision Aid ì‹¤ì‹œê°„ ê°ì§€</title>
  <!--
    CSS ìŠ¤íƒ€ì¼ ì •ì˜
    CSS style definitions
  -->
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 2rem;
    }
    #startBtn {
      font-size: 1.2rem;
      padding: 0.5rem 1rem;
      margin-top: 1rem;
    }
    #status {
      margin: 1.5rem 0;
      font-size: 1.1rem;
      color: #333;
    }
    .result-box {
      margin-top: 2rem;
      font-size: 1.1rem;
      color: #222;
      line-height: 1.8;
    }
    #ttsStatus {
      margin-top: 1rem;
      color: #007700;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <!--
    í˜ì´ì§€ ì œëª© ë° ì£¼ìš” ì¸í„°í˜ì´ìŠ¤ ìš”ì†Œ
    Page title and main UI elements
  -->
  <h1>Vision Aid ì‹¤ì‹œê°„ ê°ì§€</h1>
  <p id="status">ëŒ€ê¸° ì¤‘â€¦</p>
  <button id="startBtn">ì‹œì‘</button>
  <audio id="player"></audio>
  <p id="ttsStatus">ğŸ”‡ ìŒì„± ì—†ìŒ</p>

  <!--
    ê°ì§€ ê²°ê³¼ í‘œì‹œ ì˜ì—­
    Detection result display area
  -->
  <div class="result-box">
    <div><strong>ì‹ í˜¸ë“± ìƒíƒœ:</strong> <span id="trafficLabel">-</span></div>
    <div><strong>íš¡ë‹¨ë³´ë„:</strong> <span id="crosswalk">-</span></div>
    <div><strong>íš¡ë‹¨ë³´ë„ ìœ„ ê°ì²´:</strong> <span id="onCrosswalk">-</span></div>
  </div>

  <!--
    ì‹¤ì‹œê°„ ê°ì§€ ë° ìŒì„± ì¬ìƒìš© JS ì½”ë“œ
    JavaScript code for polling detection and playing TTS
  -->
  <script>
    // ì£¼ìš” ìš”ì†Œ ì„ íƒ / Select main DOM elements
    const serverRoot = "";
    const statusEl   = document.getElementById("status");
    const player     = document.getElementById("player");
    const ttsStatus  = document.getElementById("ttsStatus");
    const btn        = document.getElementById("startBtn");

    const trafficEl  = document.getElementById("trafficLabel");
    const crosswalkEl = document.getElementById("crosswalk");
    const onCrossEl  = document.getElementById("onCrosswalk");

    // ì˜¤ë””ì˜¤ ì¬ìƒ ì¢…ë£Œì‹œ ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸ / Update status when audio ends
    player.onended = () => {
      ttsStatus.textContent = "ğŸ”‡ ìŒì„± ì—†ìŒ";
    };

    // ì„œë²„ì—ì„œ ê²°ê³¼ í´ë§ ë° TTS ì¬ìƒ / Poll server for results & play TTS
    async function pollAndPlay() {
      try {
        const res = await fetch(serverRoot + "/latest_detection");
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const j = await res.json();
        const result = j.result;

        // ê°ì§€ ê²°ê³¼ UI ê°±ì‹  / Update UI with detection results
        trafficEl.textContent = result.traffic_label || "ì—†ìŒ";
        crosswalkEl.textContent = result.has_crosswalk ? "ìˆìŒ" : "ì—†ìŒ";
        onCrossEl.textContent = (result.objects_on_crosswalk || []).join(", ") || "ì—†ìŒ";

        statusEl.textContent = `${trafficEl.textContent}, íš¡ë‹¨ë³´ë„: ${crosswalkEl.textContent}`;

        // TTS íŒŒì¼ ìˆìœ¼ë©´ ìŒì„± ì¬ìƒ / Play audio if TTS is available
        if (j.tts_url) {
          const ttsPath = `${serverRoot + j.tts_url}?t=${Date.now()}`;
          player.src = ttsPath;
          await player.play();
          ttsStatus.textContent = "ğŸµ ìŒì„± ì¶œë ¥ ì¤‘...";
        }
      } catch (e) {
        // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë©”ì‹œì§€ í‘œì‹œ / Show error on failure
        console.error("Polling error:", e);
        statusEl.textContent = "âŒ ì˜¤ë¥˜ ë°œìƒ (ì½˜ì†” í™•ì¸)";
        ttsStatus.textContent = "ğŸ”‡ ìŒì„± ì—†ìŒ";
      }
    }

    // ì‹œì‘ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬ / Start polling on button click
    btn.addEventListener("click", () => {
      btn.disabled = true;
      statusEl.textContent = "ì‹œì‘ë¨: 5ì´ˆë§ˆë‹¤ ê°ì§€ í´ë§ ì¤‘â€¦";
      pollAndPlay();
      setInterval(pollAndPlay, 5000);
    });
  </script>
</body>
</html>
